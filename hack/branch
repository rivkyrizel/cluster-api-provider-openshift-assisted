#!/bin/bash
set -euo pipefail

target_version=$1
previous_version=${2:-}

next_version=${1:-}

# Fetch branches to find the latest freeze version
if [[ "${CI:-}" != "true" ]]; then
    git fetch --all
fi

# Find the latest backplane branch (freeze version)
freeze_branch=$(git branch -r | grep -E 'origin/backplane-[0-9]+\.[0-9]+$' | sed 's|.*origin/||' | sort -t. -k1,1n -k2,2n | tail -1)

if [[ -z "${freeze_branch}" ]]; then
    echo "Error: No existing backplane branches found. Cannot determine freeze version."
    exit 1
fi

freeze_version="${freeze_branch#backplane-}"
echo "Detected freeze version: ${freeze_version}"

# Calculate or use explicit next version
if [[ -n "${next_version}" ]]; then
    echo "Using explicit next version: ${next_version}"
else
    # Calculate next version (freeze + 1)
    freeze_major=$(echo "${freeze_version}" | cut -d. -f1)
    freeze_minor=$(echo "${freeze_version}" | cut -d. -f2)
    next_version="${freeze_major}.$((freeze_minor + 1))"
    echo "Calculated next version: ${next_version}"
fi

next_branch="backplane-${next_version}"
pr_branch="ffwd_${next_branch}"

if [[ "${CI:-}" != "true" ]]; then
    git checkout master
    git checkout -b "${pr_branch}"
fi

short_version=${next_version//.}

# Handle .tekton directory safely
if [ -d ".tekton" ]; then
    tekton_files_found=false
    for f in .tekton/*; do
        [ ! -e "$f" ] && continue
        tekton_files_found=true
        
        filename=$(basename "$f")
        in="./.tekton/${filename}"
        out=$(echo "${in}" | sed "s/mce-[0-9]\+/mce-${short_version}/g")
        
        if [ -f "${in}" ]; then
            [ "${in}" != "${out}" ] && git mv "${in}" "${out}"
            sed -i "s/mce-[0-9]\+/mce-${short_version}/g" "${out}"
            sed -i "s/${freeze_branch}/${next_branch}/g" "${out}"
            git add "${out}"
        fi
    done
    
    [ "$tekton_files_found" = false ] && echo "Note: .tekton directory is empty, skipping"
else
    echo "Note: .tekton directory does not exist, skipping"
fi

# add old branch to the renovate.json to target konflux updates, as it's no longer ffwd
if [ ! -f "renovate.json" ]; then
    echo "Error: renovate.json does not exist"
    exit 1
fi

if ! jq . renovate.json > /dev/null 2>&1; then
    echo "Error: renovate.json contains malformed JSON"
    exit 1
fi

if ! jq '.baseBranchPatterns += ["'"${freeze_branch}"'"]' renovate.json > renovate.updated.json; then
    echo "Error: Failed to update renovate.json"
    rm -f renovate.updated.json
    exit 1
fi

cp renovate.updated.json renovate.json
rm -f renovate.updated.json
git add renovate.json

# Update sync-branch.yaml with validation
SYNC_BRANCH_FILE=".github/workflows/sync-branch.yaml"
if [ ! -f "${SYNC_BRANCH_FILE}" ]; then
    echo "Error: ${SYNC_BRANCH_FILE} does not exist"
    exit 1
fi

sed -i "s/TARGET_BRANCH: .*$/TARGET_BRANCH: ${next_branch}/g" "${SYNC_BRANCH_FILE}"

if ! grep -q "TARGET_BRANCH: ${next_branch}" "${SYNC_BRANCH_FILE}"; then
    echo "Error: Failed to update TARGET_BRANCH in ${SYNC_BRANCH_FILE}"
    exit 1
fi

git add "${SYNC_BRANCH_FILE}"
# commit the changes

if [[ "${CI:-}" == "true" ]]; then
    if git commit -m "Prepare release branch ${next_branch} with updated Tekton YAML, sync-branch.yaml and renovate.json"; then
        git push origin "${next_branch}"
    else
        echo "No changes to commit on release branch"
    fi
else
    git commit -s -m "create ffwd branch ${next_branch}, freeze ${freeze_branch}"

    read -p "Push changes to ${pr_branch} (y/n)? " -n 1 -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git push origin "${pr_branch}"
    fi

    # branch out the new branch
    git checkout -b "upstream/${next_branch}"
    read -p "Create (push) branch ${next_branch}? (y/n)? " -n 1 -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git push upstream "${next_branch}"
    fi
fi
